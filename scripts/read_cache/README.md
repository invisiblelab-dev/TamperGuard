
# Read_cache Layer Benchmark

> **⚠️ Warning:** This script **overwrites the `config.toml`** file located at the root of the project.  
> Make sure to back up your configuration before running it.

---

## Overview

This benchmark script automates the evaluation of the **read_cache layer** in a storage stack configuration.  
It compares **I/O performance** between setups **with** and **without** the read_cache layer, under a compression-enabled environment.  

It uses the `fio` tool to perform I/O operations such as sequential/random reads, measuring the impact of caching on performance.

---

## Operation

The script dynamically:
1. **Generates a `config.toml`** with and without the read_cache layer.  
2. **Builds and runs** the FUSE filesystem.
3. **Executes benchmarks** using `fio` with the user-specified parameters.  
4. **Stops and cleans up** the running FUSE instance after tests.

The two benchmark phases are:
- **Phase 1:** compression and read_cache
- **Phase 2:** only compression

The workload generated by this benchmark is skewed in order to simulate an appropriate testing environment for the cache.
This means some parts of the file (hot zone) are accessed more frequently than others.
The hot zone generated is 5% of the total file, so for example, if using a 1GB file the hot zone will be around 50MB.

---

## Parameters

The script accepts multiple options that influence the compression and caching configuration:

| Option | Description | Default |
|--------|--------------|----------|
| `--compress_alg ALG` | Compression algorithm (`zstd` and `lz4`) | `lz4` |
| `--compress_level N` | Compression level (`lz4`: `-3` to `12`; `zstd`: `-5` to `22`) | `0` |
| `--size SIZE` | File size for I/O test (`1G`, `500M`, `100K`, etc.) | `500M` |
| `--duration SEC` | Duration of the benchmark in seconds | `300` |
| `--bs SIZE` | Block size in bytes for the layer configuration (`4096` (4K), `262144` (256K), `1048576` (1M), etc.) | `262144` |
| `--num_blocks` | Aproximated maximum number of blocks in the cache | 400 |
| `-h`, `--help` | Display help information | — |

---

## Example Usage

```bash
./read_cache_benchmark.sh --compress_alg=zstd --compress_level=9 --size=1G --duration=60 --bs=4k --num_blocks=100
